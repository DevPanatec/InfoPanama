name: Deploy Crawler to Digital Ocean

on:
  push:
    branches: [main]
    paths:
      - 'packages/crawler/**'
      - 'packages/convex/**'
      - '.github/workflows/deploy-crawler.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Digital Ocean App Platform
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Trigger App Platform deployment
        run: |
          echo "üöÄ Triggering deployment for app ID: ${{ secrets.DO_APP_ID }}"
          doctl apps create-deployment ${{ secrets.DO_APP_ID }} --wait
          echo "‚úÖ Deployment completed successfully!"

      - name: Get deployment status
        if: always()
        run: |
          echo "üìä Checking deployment status..."
          doctl apps get ${{ secrets.DO_APP_ID }} --format ID,Spec.Name,ActiveDeployment.Phase

  notify:
    name: Notify deployment status
    runs-on: ubuntu-latest
    needs: deploy
    if: always()

    steps:
      - name: Deployment Success
        if: needs.deploy.result == 'success'
        run: |
          echo "‚úÖ Crawler deployment successful!"
          echo "The crawlers are now running on Digital Ocean"

      - name: Deployment Failure
        if: needs.deploy.result == 'failure'
        run: |
          echo "‚ùå Crawler deployment failed!"
          echo "Check the logs for more details"
          exit 1
